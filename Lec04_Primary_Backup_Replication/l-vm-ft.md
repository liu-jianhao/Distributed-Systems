# 6.824 2016第4讲：主要/备份复制

## 今天
  主/备份复制
    广泛使用：例如，GFS块服务器
    但今天具有很强的一致性（“理想”）
    如此重要，更深入地探索
  VM-FT案例研究

## 容错
  我们想要一个尽管失败仍在继续的服务！
  可用：尽管[某类]失败仍然可用
  强一致性：就像客户端的单个服务器一样
    比GFS为文件提供的更强大
  很难！
  很有用！

## 需要一个失败模型：我们将尝试应对什么？
  独立的故障停止计算机故障
   VM-FT进一步假设一次只有一个故障
  全站点电源故障（最终重启）
  网络分区
  没有错误，没有恶意

## 核心理念：复制
  *两台*服务器（或更多）
  每个副本都保留服务所需的状态
  如果一个副本失败，其他副本可以继续

## 示例：容错MapReduce主站
  实验室1工人已经是容错的，但不是主人
    主人是“单点故障”
  如果一个失败，我们可以有两个主人吗？
  [图：M1，M2，工人]
  州：
    工人名单
    完成了哪些工作
    哪些工人闲着
    TCP连接状态
    程序计数器

## 大问题：
  要复制什么状态？
  副本如何获得状态？
  什么时候切换到备份？
  在切换时是否可以看到异常？
  如何修复/重新整合？

## 两种主要方法：
  国家转移
    “主”副本执行该服务
    主要将[新]状态发送到备份
  复制状态机
    所有副本都执行所有操作
    如果相同的开始状态，
      相同的操作，
      同样的顺序，
      确定性，
      那么同样的结束状态

## 国家转移更简单
  但是国家可能很大，转移缓慢
  VM-FT使用复制状态机

## 复制状态机可以更高效
  如果与数据相比操作较小
  但要做得对，要复杂
    例如关于多核，决定论的命令
  实验室使用复制的状态机

## 什么是复制状态机？
  K / V投入和获得？
  x86说明？
  影响性能和易于实施
    主要和备份之间需要多少交互
      高级抽象机器可以传达更少的信息
    处理非确定性在x86级别上很难，但在put / get级别上更容易
  更高级别的RSM仅适用于使用更高级别界面的应用程序
    x86 RSM可以执行任何x86程序

## 容错虚拟机实用系统的设计
Scales，Nelson和Venkitachalam，SIGOPS OSR Vol 44，No 4，Dec 2010

## 非常雄心勃勃的系统：
  全系统复制
  对应用程序和客户完全透明
  任何现有软件的高可用性
  如果它运作良好将是神奇的！
  失败模型：
    1.独立硬件故障
    2.全站点电源故障
  仅限于单处理器VM
    问：多核处理器有哪些难点？

## 概观
  [图：app，O / S，VM-FT下面]
  两台机器，主要和备用; 和其他机器
  两个网络：客户端到服务器，日志记录通道
  用于持久存储的共享磁盘
  在主要的“锁定步骤”备份
    primary将所有输入发送到备份
    备份输出被删除
  主要和备份之间的心跳
    如果主要失败，则启动备份执行！

## 有什么投入？
  时钟中断
  网络中断
  磁盘中断

## 挑战：
  1.使它看起来像一个可靠的服务器
    如果主要故障和副本接管，外界会看到什么？
      如果主要在发送响应客户端之前或之后失败
      客户请求可能会丢失吗？执行了两次？
    主服务器何时向客户端发送响应？
  2.如何避免两次初选？（“裂脑综合征”）
    如果记录通道坏了怎么办？
    主要和备份都是初选吗？
  3.如何使备份成为主要的精确副本
    哪些操作必须发送到备份？
      时钟中断？
    如何处理非决定论？
      例如，中断必须在备份时以与主要相同的指令传送

## 挑战3解决方案：确定性重播
  目标：使x86平台具有确定性
    想法：使用虚拟机管理程序使虚拟x86平台具有确定性
    两个阶段：记录和重播
  将所有硬件事件记录到日志中
    时钟中断，网络中断，I / O中断等
    对于非确定性指令，记录其他信息
      例如，记录时间戳寄存器的值
      on replay：从日志而不是实际寄存器返回值
  重播：按相同指令以相同顺序发送输入
    如果在记录期间在执行第n条指令时传送时钟中断
    在重放期间，还在第n条指令处提供时钟中断
  给定事件日志，确定性重放会重新创建VM
    管理程序提供第一个事件
    让机器执行下一个事件
      使用特殊的硬件寄存器来使处理器停在正确的指令处
    虚拟x86在重放期间执行与录制期间相同的操作
      OS运行相同
      应用运行相同
      - >录制期间将在重放时生成相同的输出
  限制：无法处理多核处理器x86
    记录和重放正确的指令交错太昂贵了

## 确定性重放在VM-FT中的应用：
  主记录中的管理程序
    通过日志记录通道将日志条目发送到备份
  备份中的Hypervisor重放日志条目
    我们需要在下一个事件的指令处停止虚拟x86
    我们需要接下来的事件
    - >备份滞后于一个事件
    
## 例：
  主要接收网络中断
    管理程序将中断和数据转发到备份
    管理程序向OS内核提供网络中断
    OS内核运行
    kernel将数据包传递给服务器
    服务器/内核写入对网卡的响应
    管理程序获得控制权并将响应放在线路上
  backup接收日志条目
    备份提供网络中断
    管理程序向其OS内核提供中断
    ...
    服务器/内核向网卡发送响应
    管理程序获得控制权
      *不*在电线上放置响应
    管理程序忽略本地时钟中断
      它从主要时钟获得时钟中断
  主要和备份获得相同的输入，最终处于相同的状态

## 挑战1解决方案：FT协议
  主要延迟任何输出直到备份确认
    每个输出操作的日志条目
    主备份接收输出操作后发送输出
  性能优化：
    primary继续执行传递的输出操作
    缓冲输出直到备份确认

## 问：为什么在备份被激活之前将输出事件发送到备份并延迟输出？
  考虑：不记录输出事件。仅记录输入事件。
  主：
    处理网络输入
    产生输出
    主要失败
  备份无法正确重现此序列：
    最后一个日志条目是：进程网络输入
      将它传递给内核
    备份变为“直播”
      它成为主要的
    硬件中断（例如，时钟）
      将它传递给内核（因为备份现在是实时的）
    网络输入导致输出
      在硬件中断之前或之前做过主要产品输出？
      备份不知道
        它没有中断的日志条目
	它没有输出的日志条目
      很重要，因为时钟中断可能会影响输出
  通过将启动输出事件发送到备份，备份可以正确地订购事件
    启动输出事件之前或之后的时钟中断

## 问：主要和备份可以产生相同的输出事件吗？ 
  A：是的！
  主要将启动输出事件发送到备份
  初级产生输出
  主要失败
  备份声明主要死亡
  备份通过启动输出事件进行重放
  备份变为现场
  备份执行输出事件
  - >作者声称两次产生输出是*不是问题
    如果输出是网络数据包，则客户端必须能够处理重复的数据包
    如果输出写入磁盘，则将相同的数据写入两次到同一位置
      但是之间不能有任何其他写入（它们会出现在日志中）
      所以，应该没问题
    如果输出被读取到磁盘，则将相同的数据两次读取到内存中的相同位置
      使用反弹缓冲来消除DMA竞争
      提供有关I / O完成中断的数据
    
## 问：主要在接收网络输入之后但之前失败时会发生什么
发送相应的日志条目进行备份？
  答：网络输入。服务依赖于客户端重试。
    这是合理的，因为网络可能丢失了请求数据包
  答：磁盘输入。管理程序重新启动挂起的磁盘I / O.

## 挑战2解决方案：共享磁盘
  只有不可靠的网络难以解决的问题！
    看下周的讲座
  Paper的解决方案：假设共享磁盘
    备份通过上次日志条目进行重放
    在磁盘上备份原子测试和设置变量
      如果设置，则主要仍处于活动状态。自杀
      如果没有设置，主要是死的。成为主要的
      如果是primary，则从检查点创建新备份
        使用VMotion
      
## 共享存储是单点故障
    如果共享存储已关闭，则服务已关闭
  确定纸张的设置，但适用于地理复制服务
    地震无法生存

## 问：为什么没有主记录登录共享磁盘，然后备份重放日志？
  优点：无需记录通道，无FT协议等。

## 问：主要故障后服务无法使用多长时间？
  检测失败
  执行日志条目
    如果备份太落后，VM-FT会降低主要速度
  写共享存储
  切换到“直播”

## 实施挑战：
  网络堆栈
    异步事件陷入虚拟机管理程序
    减少因将网络输出通信到备份而导致的额外延迟
  磁盘I / O.
    DMA

## 表现（表1）
  FT /非FT：令人印象深刻！
    有点慢
  记录带宽
    my-sql为18 Mbit / s
      因为备份不从磁盘读取
      从locak磁盘读取：8 Mbit / s
  网络应用：FT显着限制网络带宽
    必须将所有输入包转发到备份
  对于高性能服务还不够好？

## 概要：
  主备份复制
    VM-FT：干净的例子
  如何应对裂脑综合症？
    下一讲
  如何获得更好的表现？
    使用更高级别的复制状态机进行主回复制
      键/值操作，如put和get

  
----

VMware KB（＃1013428）讨论了多CPU支持。VM-FT可能已经切换
从复制的状态机方法到状态转移方法，但是
不清楚这是否属实。

http://www.wooditwork.com/2014/08/26/whats-new-vsphere-6-0-fault-tolerance/
http://www.tomsitpro.com/articles/vmware-vsphere-6-fault-tolerance-multi-cpu,1-2439.html